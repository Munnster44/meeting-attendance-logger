<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Meeting Attendance Logger v1.6 (PWA-Stable)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1f4e8c">
  <style>
    * { box-sizing: border-box; }
    body { margin:0; font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background:#f5f9ff; color:#123; }
    header,footer{background:#1f4e8c;color:#fff;padding:10px 20px;}
    header h1{margin:0;font-size:1.35rem;}
    header .subtitle{font-size:.8rem;opacity:.9;}
    footer{text-align:center;font-size:.8rem;}
    main{padding:15px;max-width:1100px;margin:auto;}
    h2{margin:0;color:#1f4e8c;font-size:1.1rem;}
    .card{background:#fff;border-radius:8px;padding:12px 14px;margin-bottom:12px;
          box-shadow:0 1px 4px rgba(0,0,0,0.08);}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
    .pill{padding:2px 8px;border-radius:999px;font-size:.75rem;background:#e1ecff;color:#1f4e8c;}
    .form-row{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:8px;}
    .form-group{flex:1 1 140px;min-width:140px;}
    label{font-size:.8rem;margin-bottom:2px;color:#345;display:block;}
    input,select,textarea{width:100%;padding:5px 7px;font-size:.9rem;border:1px solid #c7d7f2;border-radius:4px;}
    textarea{min-height:50px;resize:vertical;}
    .btn-bar{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;}
    button{border:0;border-radius:4px;padding:6px 10px;font-size:.85rem;cursor:pointer;display:inline-flex;align-items:center;gap:4px;}
    button.primary{background:#1f4e8c;color:#fff;}
    button.secondary{background:#e1ecff;color:#123;}
    button.danger{background:#c0392b;color:#fff;}
    button:disabled{opacity:.6;cursor:default;}
    table{width:100%;border-collapse:collapse;font-size:.82rem;}
    thead{background:#e9f1ff;}
    th,td{padding:4px 6px;border-bottom:1px solid #dde6f5;text-align:left;}
    th.sortable{cursor:pointer;user-select:none;}
    tr:nth-child(even){background:#f7fbff;}
    .attended-yes{background:#e2f7e5;}
    .badge-attended{background:#27ae60;color:#fff;padding:1px 6px;border-radius:999px;font-size:.7rem;}
    .badge-absent{background:#bdc3c7;color:#2c3e50;padding:1px 6px;border-radius:999px;font-size:.7rem;}
    .stats{font-size:.8rem;margin-top:4px;color:#345;}
    .stats .green{color:#27ae60;font-weight:600;}
    .stats .red{color:#c0392b;font-weight:600;}
    /* Modals */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;
      align-items:center;justify-content:center;z-index:999;}
    .modal-content{background:#fff;border-radius:10px;max-width:820px;width:95%;
      max-height:80vh;display:flex;flex-direction:column;box-shadow:0 4px 12px rgba(0,0,0,0.25);}
    .modal-header{background:#1f4e8c;color:#fff;padding:10px 14px;
      display:flex;justify-content:space-between;align-items:center;}
    .modal-body{padding:10px 14px;overflow-y:auto;font-size:.85rem;}
    .modal-footer{text-align:right;padding:8px 14px;border-top:1px solid #dde6f5;}
    .report-toggle{display:flex;border:1px solid #c7d7f2;border-radius:999px;overflow:hidden;margin-bottom:8px;}
    .report-toggle button{border:0;padding:4px 10px;background:#f1f5ff;font-size:.8rem;}
    .report-toggle .active{background:#1f4e8c;color:#fff;}
    .report-content-box{border:1px solid #dde6f5;border-radius:6px;padding:8px;
       background:#fdfefe;white-space:pre-wrap;font-size:.82rem;}
  </style>
</head>
<body>

<header>
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div>
      <h1>Meeting Attendance Logger</h1>
      <div class="subtitle">Simple Edition • v1.6 (PWA-Stable)</div>
    </div>
    <button class="secondary" id="readmeBtn">README</button>
  </div>
</header>

<main>

<!-- Meeting Details -->
<section class="card">
  <div class="card-header">
    <h2>Meeting Details</h2>
    <span class="pill" id="meetingTypeBadge">Type: Not set</span>
  </div>

  <div class="form-row">
    <div class="form-group"><label>Meeting name</label><input id="meetingName" type="text"></div>
    <div class="form-group"><label>Date</label><input id="meetingDate" type="date"></div>
    <div class="form-group"><label>Time</label><input id="meetingTime" type="time"></div>
    <div class="form-group"><label>Duration (hours)</label><input id="meetingDuration" type="number" step="0.25" min="0"></div>
  </div>

  <div class="form-row">
    <div class="form-group"><label>Location</label><input id="meetingLocation" type="text"></div>
    <div class="form-group"><label>Meeting type</label>
      <select id="meetingType">
        <option value="">-- Select --</option>
        <option value="Online">Online</option>
        <option value="Face-to-Face">Face-to-Face</option>
        <option value="Hybrid">Hybrid</option>
      </select>
    </div>
    <div class="form-group"><label>Notes</label><textarea id="meetingNotes"></textarea></div>
  </div>

  <div style="font-size:.75rem;color:#567;">
    Meeting details appear in CSV and report. Hours apply only to those marked attended.
  </div>
</section>

<!-- Attendee Manager -->
<section class="card">
  <div class="card-header">
    <h2>Attendee Manager</h2>
    <div style="font-size:.8rem;">Mode: <strong id="editModeLabel">Add new attendee</strong></div>
  </div>

  <div class="form-row">
    <div class="form-group"><label>First name</label><input id="firstName"></div>
    <div class="form-group"><label>Last name*</label><input id="lastName"></div>
    <div class="form-group"><label>Position / Role</label><input id="position"></div>
  </div>

  <div class="form-row">
    <div class="form-group"><label>ID number</label><input id="memberId"></div>
    <div class="form-group"><label>Squadron</label><input id="squadron"></div>
    <div class="form-group"><label>&nbsp;</label>
      <div class="btn-bar">
        <button class="primary" id="saveAttendeeBtn">Add attendee</button>
        <button class="secondary" id="cancelEditBtn" disabled>Cancel edit</button>
      </div>
    </div>
  </div>

  <div style="font-size:.75rem;color:#567;">*Last name is required.</div>
</section>

<!-- Attendee List -->
<section class="card">
  <div class="card-header">
    <h2>Attendance List</h2>
    <div class="btn-bar">
      <button class="secondary" id="downloadJsonBtn">Save roster (.json)</button>
      <button class="secondary" id="loadFromFileBtn">Load roster (JSON)</button>
      <button class="secondary" id="downloadCsvBtn">Save as CSV</button>
      <button class="secondary" id="clearAttendanceBtn">Clear attendance</button>
      <button class="danger"    id="clearAllAttendeesBtn">Clear all attendees</button>
      <button class="primary"   id="viewReportBtn">View report</button>
    </div>
  </div>

  <input id="loadFileInput" type="file" accept=".json" style="display:none">

  <div class="form-row">
    <div class="form-group">
      <label>Search</label>
      <input id="searchBox" type="text">
    </div>
    <label style="align-self:end;">
      <input id="showAttendedOnly" type="checkbox"> Show attended only
    </label>
  </div>

  <div style="overflow-x:auto;">
    <table id="attendeeTable">
      <thead>
        <tr>
          <th class="sortable" data-sort="lastName">Last name</th>
          <th class="sortable" data-sort="firstName">First name</th>
          <th class="sortable" data-sort="position">Position</th>
          <th class="sortable" data-sort="memberId">ID</th>
          <th class="sortable" data-sort="squadron">Squadron</th>
          <th class="sortable" data-sort="hours">Hours</th>
          <th>Attended?</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="stats" id="statsBar">Total: 0 | <span class="green">Attended: 0</span> | <span class="red">Absent: 0</span></div>
</section>

</main>

<footer>
  © 2025 Glen Carruthers — Meeting Attendance Logger v1.6 (PWA-Stable)
</footer>

<!-- README Modal -->
<div class="modal-overlay" id="readmeModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>README</h3>
      <button class="secondary" id="readmeCloseBtnTop">✕</button>
    </div>
    <div class="modal-body">
      <p><strong>Meeting Attendance Logger — Simple Edition v1.6 (PWA-Stable)</strong></p>
      <ul>
        <li><strong>Meeting details</strong> at the top are included in CSV export and the text report.</li>
        <li><strong>Attendee Manager</strong>: add/edit attendees. Last name is required.</li>
        <li><strong>Attendance List</strong>:
          <ul>
            <li><em>Save roster (.json)</em> — saves the attendee roster only (for reuse next time).</li>
            <li><em>Load roster (JSON)</em> — reloads a previously saved roster file.</li>
            <li><em>Save as CSV</em> — saves meeting + attendees to a CSV (spreadsheet-friendly text file).</li>
            <li><em>Clear attendance</em> — sets all attendees to “Absent” but keeps the list.</li>
            <li><em>Clear all attendees</em> — deletes all attendees from the list.</li>
            <li><em>Search</em> and <em>Show attended only</em> help filter the list.</li>
          </ul>
        </li>
        <li><strong>Report</strong>:
          <ul>
            <li>Generates a meeting attendance report (Present + Absent sections).</li>
            <li><em>Download .txt</em> saves the meeting attendee document as a plain text file.</li>
            <li><em>Copy</em> places the report text in your clipboard.</li>
            <li><em>Open in new tab</em> shows the report in a separate tab as text.</li>
            <li><em>Print</em> opens a printer-friendly version of the report.</li>
          </ul>
        </li>
        <li><strong>PWA / Offline</strong>:
          <ul>
            <li>Once opened from the web, the app is cached for offline use (via service worker).</li>
            <li>On most browsers/devices you can use “Install” or “Add to Home Screen” to pin the app.</li>
          </ul>
        </li>
      </ul>
    </div>
    <div class="modal-footer"><button class="secondary" id="readmeCloseBtnBottom">Close</button></div>
  </div>
</div>

<!-- REPORT Modal -->
<div class="modal-overlay" id="reportModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Meeting Attendance Report</h3>
      <button class="secondary" id="reportCloseBtnTop">✕</button>
    </div>

    <div class="modal-body">
      <div class="report-toggle">
        <button id="formattedViewBtn" class="active">Formatted</button>
        <button id="plainViewBtn">Plain</button>
      </div>

      <div id="reportContent" class="report-content-box"></div>

      <div class="btn-bar" style="justify-content:flex-end;margin-top:10px;">
        <button class="secondary" id="reportCopyBtn">Copy</button>
        <button class="secondary" id="reportDownloadBtn">Download .txt</button>
        <button class="secondary" id="reportNewTabBtn">Open in new tab</button>
        <button class="secondary" id="reportPrintBtn">Print</button>
        <!-- EMAIL BUTTON REMOVED -->
      </div>
    </div>

    <div class="modal-footer">
      <button class="secondary" id="reportCloseBtnBottom">Close</button>
    </div>
  </div>
</div>

<script>
/* ---------------------------------------------
   Core Data
--------------------------------------------- */
let attendees = [];
let editingIndex = null;
let currentSortField = "lastName";
let currentSortDirection = "asc";

/* Utility */
function $(id){ return document.getElementById(id); }
function getDuration(){
  const v = parseFloat($("meetingDuration").value);
  return isNaN(v) ? "" : v;
}
function escapeHtml(str){
  return String(str)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}

/* Meeting type badge */
function updateMeetingTypeBadge(){
  const t = $("meetingType").value;
  const b = $("meetingTypeBadge");
  if(!t){
    b.textContent = "Type: Not set";
    b.style.background = "#e1ecff";
    b.style.color = "#1f4e8c";
    return;
  }
  b.textContent = "Type: " + t;
}

/* Normalize attendee */
function normalize(a){
  return {
    firstName:(a.firstName||"").trim(),
    lastName:(a.lastName||"").trim(),
    position:(a.position||"").trim(),
    memberId:(a.memberId||"").trim(),
    squadron:(a.squadron||"").trim(),
    attended:!!a.attended
  };
}

/* Render Table */
function render(){
  const tb = $("attendeeTable").querySelector("tbody");
  tb.innerHTML = "";
  const search = $("searchBox").value.trim().toLowerCase();
  const onlyAtt = $("showAttendedOnly").checked;
  const hrs = getDuration();

  let list = attendees.map((a,i)=>({...a,_i:i}));

  if(search){
    list = list.filter(a=>{
      return (a.firstName+" "+a.lastName+" "+a.position+" "+
              a.memberId+" "+a.squadron).toLowerCase().includes(search);
    });
  }
  if(onlyAtt) list = list.filter(a=>a.attended);

  list.sort((a,b)=>{
    let f = currentSortField;
    let va = f==="hours" ? (a.attended?hrs:0) : (a[f]||"").toLowerCase();
    let vb = f==="hours" ? (b.attended?hrs:0) : (b[f]||"").toLowerCase();
    if(va<vb) return currentSortDirection==="asc"?-1:1;
    if(va>vb) return currentSortDirection==="asc"?1:-1;
    return 0;
  });

  list.forEach(a=>{
    const tr = document.createElement("tr");
    if(a.attended) tr.classList.add("attended-yes");

    tr.innerHTML =
      `<td>${a.lastName}</td>
       <td>${a.firstName}</td>
       <td>${a.position}</td>
       <td>${a.memberId}</td>
       <td>${a.squadron}</td>
       <td>${a.attended?hrs:""}</td>`;

    const tdAtt = document.createElement("td");
    const chk = document.createElement("input");
    chk.type = "checkbox"; chk.checked = a.attended;
    chk.onchange = ()=>{
      attendees[a._i].attended = chk.checked;
      updateStats();
      render();
    };
    tdAtt.appendChild(chk);
    tdAtt.append(" ");
    const badge = document.createElement("span");
    badge.className = a.attended ? "badge-attended" : "badge-absent";
    badge.textContent = a.attended ? "Present" : "Absent";
    tdAtt.appendChild(badge);
    tr.appendChild(tdAtt);

    const tdAct = document.createElement("td");
    const eBtn = document.createElement("button");
    eBtn.className = "secondary"; eBtn.textContent = "Edit";
    eBtn.onclick = ()=>editEntry(a._i);
    const dBtn = document.createElement("button");
    dBtn.className = "danger"; dBtn.textContent = "Delete"; dBtn.style.marginLeft="4px";
    dBtn.onclick = ()=>{
      if(confirm("Delete this attendee?")){
        attendees.splice(a._i,1);
        clearForm();
        render();
        updateStats();
      }
    };
    tdAct.appendChild(eBtn);
    tdAct.appendChild(dBtn);
    tr.appendChild(tdAct);

    tb.appendChild(tr);
  });

  updateStats();
}

/* Stats */
function updateStats(){
  const t = attendees.length;
  const att = attendees.filter(a=>a.attended).length;
  $("statsBar").innerHTML =
    `Total: ${t} | <span class="green">Attended: ${att}</span> | <span class="red">Absent: ${t-att}</span>`;
}

/* Form */
function readForm(){
  return {
    firstName:$("firstName").value,
    lastName:$("lastName").value,
    position:$("position").value,
    memberId:$("memberId").value,
    squadron:$("squadron").value,
    attended:false
  };
}
function clearForm(){
  ["firstName","lastName","position","memberId","squadron"].forEach(id=>$(id).value="");
  editingIndex = null;
  $("editModeLabel").textContent = "Add new attendee";
  $("saveAttendeeBtn").textContent = "Add attendee";
  $("cancelEditBtn").disabled = true;
}
function editEntry(i){
  const a = attendees[i];
  $("firstName").value = a.firstName;
  $("lastName").value = a.lastName;
  $("position").value = a.position;
  $("memberId").value = a.memberId;
  $("squadron").value = a.squadron;
  editingIndex = i;
  $("editModeLabel").textContent = "Editing attendee #"+(i+1);
  $("saveAttendeeBtn").textContent = "Save";
  $("cancelEditBtn").disabled = false;
}

/* JSON Save */
function saveJson(){
  const json = JSON.stringify({
    app:"MeetingAttendanceLogger",
    version:"1.6-PWA-Stable",
    savedAt:new Date().toISOString(),
    attendees:attendees.map(normalize)
  },null,2);
  downloadBlob(json,"roster.json","application/json");
}

/* JSON Load */
$("loadFromFileBtn").onclick = () => {
  $("loadFileInput").click();
};

$("loadFileInput").onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (evt) => {
    try {
      const data = JSON.parse(evt.target.result);

      let list = [];

      // Correct structure: { attendees:[...] }
      if (data.attendees && Array.isArray(data.attendees)) {
        list = data.attendees;
      }
      // Also support plain array
      else if (Array.isArray(data)) {
        list = data;
      }
      else {
        alert("Invalid roster format.\nExpected an object with an 'attendees' list.");
        return;
      }

      attendees = list.map(normalize);
      clearForm();
      render();
      updateStats();
      alert("Roster loaded successfully!");

    } catch (err) {
      console.error(err);
      alert("Unable to read JSON file.");
    }
  };

  reader.readAsText(file);
  e.target.value = "";
};

/* CSV — Save As dialog */
async function saveCsv(){
  if(attendees.length===0){
    alert("No attendees to export.");
    return;
  }

  const csv = buildCsv();
  
  if(window.showSaveFilePicker){
    try{
      const handle = await showSaveFilePicker({
        suggestedName:"meeting-attendance.csv",
        types:[{description:"CSV Files",accept:{"text/csv":[".csv"]}}]
      });
      const writable = await handle.createWritable();
      await writable.write(csv);
      await writable.close();
      return;
    }catch(e){
      console.warn("Picker failed, fallback",e);
    }
  }

  downloadBlob(csv,"meeting-attendance.csv","text/csv");
}

function buildCsv(){
  const h = [
    `Meeting Name:,"${$("meetingName").value}"`,
    `Date:,"${$("meetingDate").value}"`,
    `Time:,"${$("meetingTime").value}"`,
    `Location:,"${$("meetingLocation").value}"`,
    `Type:,"${$("meetingType").value}"`,
    `Duration:,${getDuration()}`,
    `Notes:,"${$("meetingNotes").value.replace(/"/g,'""')}"`,
    ""
  ];
  const head = "First,Last,Position,ID,Squadron,Attended,Hours";
  const rows = attendees.map(a=>{
    const hrs = a.attended ? getDuration() : "";
    return `"${a.firstName}","${a.lastName}","${a.position}","${a.memberId}","${a.squadron}","${a.attended?"Yes":"No"}","${hrs}"`;
  });
  return [...h,head,...rows].join("\r\n");
}

function downloadBlob(content,name,type){
  const b = new Blob([content],{type});
  const u = URL.createObjectURL(b);
  const a = document.createElement("a");
  a.href = u;
  a.download = name;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(u);
}

/* Report */
function buildReport(){
  const d = $("meetingDate").value;
  const t = $("meetingTime").value;
  const dur = getDuration();
  let txt = "Meeting Attendance Report\r\n----------------------\r\n";
  txt += `Meeting: ${$("meetingName").value}\r\n`;
  txt += `Date: ${d}\r\nTime: ${t}\r\nLocation: ${$("meetingLocation").value}\r\n`;
  txt += `Type: ${$("meetingType").value}\r\nDuration: ${dur}\r\n\r\n`;

  const present = attendees.filter(a=>a.attended);
  const absent = attendees.filter(a=>!a.attended);

  txt += `Present (${present.length})\r\n`;
  present.forEach(a=>txt += ` - ${a.lastName}, ${a.firstName} (${a.position}) [${a.memberId}] ${a.squadron}\r\n`);

  txt += `\r\nAbsent (${absent.length})\r\n`;
  absent.forEach(a=>txt += ` - ${a.lastName}, ${a.firstName} (${a.position}) [${a.memberId}] ${a.squadron}\r\n`);

  return txt;
}

function openReport(){
  if(attendees.length===0){
    alert("No attendees.");
    return;
  }
  $("reportContent").textContent = buildReport();
  $("reportModal").style.display = "flex";
}

function printReport(){
  const reportText = buildReport();
  const win = window.open("", "_blank");
  if(!win){
    alert("Pop-up blocked. Please allow pop-ups for this site to print.");
    return;
  }
  win.document.write("<!DOCTYPE html><html><head><title>Meeting Attendance Report</title></head><body><pre>" +
    escapeHtml(reportText) +
    "</pre></body></html>");
  win.document.close();
  win.focus();
  win.print();
}

/* Init */
document.addEventListener("DOMContentLoaded",()=>{

  $("meetingType").onchange = updateMeetingTypeBadge;

  $("saveAttendeeBtn").onclick = ()=>{
    const a = readForm();
    if(!a.lastName){
      alert("Last name required.");
      return;
    }
    if(editingIndex===null) attendees.push(a);
    else attendees[editingIndex] = {...normalize(a),attended:attendees[editingIndex].attended};
    clearForm();
    render();
  };
  $("cancelEditBtn").onclick = clearForm;

  $("downloadJsonBtn").onclick = saveJson;
  $("downloadCsvBtn").onclick = saveCsv;
  $("clearAttendanceBtn").onclick = ()=>{
    attendees.forEach(a=>a.attended=false);
    render();
  };
  $("clearAllAttendeesBtn").onclick = ()=>{
    if(confirm("This will delete ALL attendees from the list. Continue?")){
      attendees = [];
      clearForm();
      render();
      updateStats();
    }
  };

  $("searchBox").oninput = render;
  $("showAttendedOnly").onchange = render;

  document.querySelectorAll("th.sortable").forEach(th=>{
    th.onclick = ()=>{
      const f = th.dataset.sort;
      if(currentSortField===f) currentSortDirection = (currentSortDirection==="asc"?"desc":"asc");
      else{
        currentSortField = f;
        currentSortDirection = "asc";
      }
      render();
    };
  });

  /* Report modal */
  $("viewReportBtn").onclick = openReport;
  $("reportCloseBtnTop").onclick = ()=>$("reportModal").style.display="none";
  $("reportCloseBtnBottom").onclick = ()=>$("reportModal").style.display="none";

  $("formattedViewBtn").onclick = ()=>{
    $("formattedViewBtn").classList.add("active");
    $("plainViewBtn").classList.remove("active");
    $("reportContent").classList.remove("plain");
    $("reportContent").textContent = buildReport();
  };
  $("plainViewBtn").onclick = ()=>{
    $("plainViewBtn").classList.add("active");
    $("formattedViewBtn").classList.remove("active");
    $("reportContent").classList.add("plain");
    $("reportContent").textContent = buildReport();
  };

  $("reportCopyBtn").onclick = async()=>{
    try{
      await navigator.clipboard.writeText(buildReport());
      alert("Copied.");
    }catch(e){
      alert("Copy failed.");
    }
  };
  $("reportDownloadBtn").onclick = ()=>downloadBlob(buildReport(),"meeting-report.txt","text/plain");
  $("reportNewTabBtn").onclick = ()=>{
    const blob = new Blob([buildReport()],{type:"text/plain"});
    const url = URL.createObjectURL(blob);
    window.open(url,"_blank");
  };
  $("reportPrintBtn").onclick = printReport;

  /* README */
  $("readmeBtn").onclick = ()=>$("readmeModal").style.display="flex";
  $("readmeCloseBtnTop").onclick = ()=>$("readmeModal").style.display="none";
  $("readmeCloseBtnBottom").onclick = ()=>$("readmeModal").style.display="none";

  render();
  updateMeetingTypeBadge();
});

/* ---------------------------------------------
   PWA: Manifest + Service Worker (single-file)
--------------------------------------------- */
(function(){
  if (!('serviceWorker' in navigator)) return;

  // Simple MA icon (dark blue background, white "MA")
  const svgIcon =
    '<svg xmlns="http://www.w3.org/2000/svg" width="192" height="192" viewBox="0 0 192 192">'+
    '<rect width="192" height="192" rx="32" ry="32" fill="#1f4e8c"/>'+
    '<text x="50%" y="50%" text-anchor="middle" dominant-baseline="central" '+
    'font-family="system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif" '+
    'font-size="72" fill="#ffffff" font-weight="700">MA</text>'+
    '</svg>';

  const iconUrl = 'data:image/svg+xml;utf8,' + encodeURIComponent(svgIcon);

  const manifest = {
    name: "Meeting Attendance Logger v1.6 (PWA-Stable)",
    short_name: "Attendance",
    start_url: ".",
    display: "standalone",
    background_color: "#1f4e8c",
    theme_color: "#1f4e8c",
    icons: [
      { src: iconUrl, sizes: "192x192", type: "image/svg+xml" },
      { src: iconUrl, sizes: "512x512", type: "image/svg+xml" }
    ]
  };

  // Inject manifest dynamically
  const manifestBlob = new Blob([JSON.stringify(manifest)], {type: "application/json"});
  const manifestURL = URL.createObjectURL(manifestBlob);
  const link = document.createElement("link");
  link.rel = "manifest";
  link.href = manifestURL;
  document.head.appendChild(link);

  // Service worker code (cache-first with update)
  const swCode = `
    const CACHE_NAME = 'meeting-attendance-logger-v1-6-pwa-stable';
    self.addEventListener('install', event => {
      self.skipWaiting();
      event.waitUntil(caches.open(CACHE_NAME));
    });
    self.addEventListener('activate', event => {
      event.waitUntil(
        caches.keys().then(keys =>
          Promise.all(
            keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k))
          )
        )
      );
      self.clients.claim();
    });
    self.addEventListener('fetch', event => {
      if (event.request.method !== 'GET') return;
      event.respondWith(
        caches.open(CACHE_NAME).then(cache =>
          fetch(event.request)
            .then(response => {
              cache.put(event.request, response.clone());
              return response;
            })
            .catch(() =>
              cache.match(event.request).then(match => match || Promise.reject('no-match'))
            )
        )
      );
    });
  `;

  const swBlob = new Blob([swCode], {type: "text/javascript"});
  const swUrl = URL.createObjectURL(swBlob);

  window.addEventListener("load", () => {
    navigator.serviceWorker.register(swUrl).catch(err=>{
      console.error("Service worker registration failed:", err);
    });
  });
})();
</script>

</body>
</html>
